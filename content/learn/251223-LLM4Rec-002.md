---
title: "LLM4Rec-Learning-002: å¤§æ¨¡å‹æ¨èçš„Pipline"
date: 2025-12-24
draft: false
tags: ["å¤§æ¨¡å‹","æ¨èç³»ç»Ÿ"]
categories: ["å­¦ä¹ ", "LLM4Rec"]
---

{{< quote >}}
æœ¬èŠ‚æ˜¯LLM4Recçš„Piplineï¼Œä»è®ºæ–‡ã€æ•°æ®åˆ°æºç ä¸€æ­¥æ­¥è¿›è¡Œæ¢ç´¢
å›´ç»•â€œTIGERâ€è®ºæ–‡å±•å¼€
{{< /quote >}}
<!--more-->

## ä¸»è¦å†…å®¹

- è°·æ­Œ2023å¹´çš„è®ºæ–‡â€œTIGERâ€
- [Recommender Systems with Generative Retrieval](https://arxiv.org/pdf/2305.05065v3)
- VQ-VAE & RQ-VAE
- https://github.com/EdoardoBotta/RQ-VAE-Recommender
- Amazonæ•°æ®é›†

## è®ºæ–‡è§£è¯»

### ç›¸å…³æœ¯è¯­

- Codebookï¼šç æœ¬ï¼Œæ‰€æœ‰ codewords çš„é›†åˆï¼Œshape codebook_size Ã— embed_dim ã€‚
- Codewordï¼šç å­—ï¼Œç æœ¬çš„ä¸€è¡Œå‘é‡ï¼Œä»£è¡¨ä¸€ä¸ªç¦»æ•£åŸå‹ã€‚
- Quantizeï¼ˆé‡åŒ–ï¼‰ï¼šå°†è¿ç»­å‘é‡ x æ˜ å°„åˆ°æœ€æ¥è¿‘çš„ codeword å¹¶è¾“å‡ºå…¶ç´¢å¼• ids ä¸åµŒå…¥ embeddings ã€‚
- Residualï¼ˆæ®‹å·®ï¼‰ï¼šå½“å‰ç¼–ç å‘é‡å‡å»é€‰ä¸­çš„ç å­—åµŒå…¥ï¼Œä¼ ç»™ä¸‹ä¸€å±‚é‡åŒ–ã€‚
- Commitment lossï¼šçº¦æŸ x è´´è¿‘ embeddings çš„æŸå¤±ï¼Œä¿ƒè¿›ä¸€è‡´æ€§ã€‚
- Gumbel-Softmaxï¼šå¯¹ logits åšå¸¦å™ª softmax æŠ½æ ·ï¼Œå¾—åˆ°å¹³æ»‘çš„ç å­—åŠ æƒå‘é‡ï¼Œæœ‰åˆ©äºç«¯åˆ°ç«¯è®­ç»ƒã€‚
- Rotation Trickï¼šç”¨æ—‹è½¬å˜æ¢é™ä½é‡åŒ–è¯¯å·®çš„å‰å‘ç­–ç•¥ã€‚



### æ•´ä½“ç»“æ„

![image-20251223094056258](https://coderethan-1327000741.cos.ap-chengdu.myqcloud.com/blog-pics/image-20251223094056258.png)



### RQ-VAEé‡åŒ–

æƒ³æƒ³è¿™å—ä¸»è¦æ˜¯åœ¨å¹²å•¥ï¼Ÿä»¥åŠä¸ºå•¥è¿™æ ·åšï¼Ÿ

![image-20251223102407170](https://coderethan-1327000741.cos.ap-chengdu.myqcloud.com/blog-pics/image-20251223102407170.png)

ğŸ“Œ æ£€ç´¢ä¸å†å‘ç”Ÿåœ¨å‘é‡ç©ºé—´

ğŸ“Œ è€Œå‘ç”Ÿåœ¨â€œtoken ç©ºé—´â€



### é‡åŒ–çš„å…¶ä»–é€‰é¡¹

> é¦–å…ˆæˆ‘ä»¬éœ€è¦æ˜ç¡®ä¸€ç‚¹ï¼ˆæ•´ä½“ä¸Šæœ‰æ„Ÿè§‰ï¼‰ï¼Œè¿™ä¸ªæ¨¡å—ä¸»è¦æ˜¯è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿæ˜¯åœ¨å¹²å•¥ï¼Ÿå¤§è‡´çš„ç­–ç•¥æ˜¯æ€æ ·çš„ï¼Ÿ

è¿™äº›ç®—æ³•ï¼Œ**æœ¬è´¨ä¸Šéƒ½æ˜¯åœ¨â€œå¤„ç†å¤§é‡é«˜ç»´æ•°æ®â€**ï¼Œ è®©æˆ‘ä»¬èƒ½ **æ›´å¿«åœ°æ‰¾ç›¸ä¼¼ä¸œè¥¿ï¼Œæˆ– **æ›´é«˜æ•ˆåœ°è¡¨ç¤ºã€å‹ç¼©ã€ç”Ÿæˆæ•°æ®**ã€‚



- å±€éƒ¨æ•æ„Ÿå“ˆå¸Œï¼ˆLSHï¼‰

    > æœ‰ **1 äº¿ä¸ªå‘é‡**ï¼ˆæ¯”å¦‚ç”¨æˆ·ç”»åƒã€å•†å“ç‰¹å¾ã€æ–‡æœ¬ embeddingï¼‰ï¼Œ ç°åœ¨æ¥äº†ä¸€ä¸ªæ–°å‘é‡ï¼Œæƒ³æ‰¾ **æœ€åƒå®ƒçš„é‚£å‡ ä¸ª**ã€‚ä¸»è¦æ˜¯å¬å›å±‚

    LSHçš„ç­–ç•¥å°±æ˜¯: ä¸ç”¨ä¸€ä¸ªä¸ªå»æ¯”ï¼Œè€Œæ˜¯å…ˆâ€œåˆ†æ¡¶â€ï¼ŒæŠŠâ€œç›¸ä¼¼çš„å‘é‡â€**å¤§æ¦‚ç‡åˆ†åˆ°åŒä¸€ä¸ªæ¡¶**ï¼Œåªåœ¨å°‘æ•°æ¡¶é‡Œæ‰¾ã€‚ä¸»è¦æ˜¯ä¸ºäº†èƒ½å¤Ÿå¿«é€Ÿå®ç°ç›¸ä¼¼åŒ¹é…æ£€ç´¢

    ç»“æ„ï¼š[ å‘é‡ ] â†’ LSH â†’ å€™é€‰é›†åˆ â†’ ç²¾æ’



- VAE

    VAEï¼šä¸»è¦å°±æ˜¯æŠŠå¤æ‚æ•°æ® ï¼ˆä¸€å¼ å›¾ç‰‡ã€ä¸€ä¸ªè¯­éŸ³ã€ä¸€ä¸ªç”¨æˆ·è¡Œä¸ºåºåˆ—å­˜åœ¨å…³è”æ€§ï¼‰**å‹ç¼©æˆä¸€å°æ®µè¿ç»­çš„æ•°å­—ï¼ˆæ½œåœ¨è¡¨ç¤ºï¼‰**ï¼ŒåŒæ—¶è¿˜èƒ½å¤Ÿ**ä»è¿™äº›æ•°å­—å†ç”Ÿæˆå›åŸå§‹æ•°æ®**ï¼›å¦å¤–ï¼Œä»–è¿˜æœ‰ä¸€ä¸ªå…³é”®ç‚¹å°±æ˜¯èƒ½å¤Ÿâ€œå¯ç”Ÿæˆã€å¯æ’å€¼â€çš„è¡¨ç¤ºã€‚ä¸»è¦æ˜¯è¡¨å¾å±‚

    ç»“æ„ï¼š[ åŸå§‹æ•°æ® ] â†’ [ Encoder ] â†’ [ è¿ç»­æ½œå˜é‡ z ] â†’ [ Decoder ] â†’ [ é‡æ„ / ç”Ÿæˆ ]

    

- VQ-VAE

    VQ-VAEï¼šæŠŠè¿ç»­æ•°æ®ï¼ˆæ¯”å¦‚Embeddingï¼‰**æ˜ å°„æˆæœ‰é™ä¸ªç¦»æ•£ç¼–å·**ï¼Œæƒ³æƒ³ä¸ºå•¥è¿™æ ·åšï¼Ÿä¸»è¦æ˜¯è¡¨å¾å±‚

    ç»“æ„ï¼š[ Encoder ] â†’ [ è¿ç»­å‘é‡ ] â†’ [ æŸ¥ç æœ¬ â†’ ç¦»æ•£ID ] â†’ [ Decoder ]

    

- RQ-VAE

    RQ-VAEï¼šç®—æ˜¯VQ-VAEçš„ä¼˜åŒ–ï¼Œä¸»è¦æ˜¯è¡¨å¾å±‚

    ç»“æ„ï¼š[ Encoder ]  â†’ [ æ®‹å·®é‡åŒ– Ã— å¤šå±‚ ]  â†’ [ å¤šä¸ªç¦»æ•£ID ]  â†’ [ Decoder / æ£€ç´¢ ]



### æ•°æ®é›†

> **Datasets.** We evaluate the proposed framework on three public real-world benchmarks from the Amazon Product Reviews dataset[10], containing user reviews and item metadata from May 1996 to July 2014. In particular, we use three categories of the Amazon Product Reviews dataset for the sequential recommendation task: â€œBeautyâ€, â€œSports and Outdoorsâ€, and â€œToys and Gamesâ€. We discuss the dataset statistics and pre-processing in Appendix C.

![image-20251224084400370](https://coderethan-1327000741.cos.ap-chengdu.myqcloud.com/blog-pics/image-20251224084400370.png)



## æºç è·‘é€š

æºç çš„`README`å†™çš„æ¯”è¾ƒæ¸…æ™°äº†ï¼Œæ•´ä½“ä¸Šæ˜¯ä¸¤ä¸ªé˜¶æ®µï¼Œé˜¶æ®µä¸€æ˜¯è¡¨å¾å­¦ä¹ ï¼Œé˜¶æ®µäºŒæ˜¯ç”Ÿæˆå¼æ¨èå­¦ä¹ 

ç”±äºé˜¶æ®µä¸€ä½œè€…ç”¨çš„T5æ¨¡å‹ï¼Œ5bå·¦å³ï¼Œæˆ‘è®¾å¤‡å¸¦ä¸èµ·æ¥ï¼Œæˆ‘å°±æ¢æˆä¸€ä¸ªå¾ˆå°çš„0.1bçš„æ¨¡å‹äº†ï¼Œç»´åº¦ä»åŸæ¥çš„768å˜ä¸º384äº†ï¼Œæ‰€ä»¥å¯¹åº”çš„å‡ ä¸ªè¾“å…¥ç»´åº¦ä¹Ÿè¦ä¿®æ”¹ä¸º384ï¼Œå¦å¤–å°±æ˜¯å‘ç°è®­ç»ƒæ—¶å€™æ•ˆæœå¾ˆå·®ï¼Œä¸ªäººçŒœæµ‹æ˜¯`vae_hidden_dims`è¿˜æ˜¯ä¹‹å‰çš„éšè—å±‚ç»´åº¦ï¼Œæœ‰ç‚¹å¤ªå¤æ‚äº†ï¼Œç„¶åæˆ‘è°ƒæ•´äº†ä¸€ä¸‹ï¼Œå‚æ•°è‡ªå·±è°ƒäº†å¥½å‡ ç±»ï¼Œæœ€åå¤§è‡´ é”å®šåœ¨äº†ä¸€ä¸ªèŒƒå›´ï¼Œä¹Ÿæ˜¯æ•ˆæœä¸é”™çš„äº†ï¼Œåé¢è¿›è¡Œç¬¬äºŒä¸ªæ­¥éª¤ã€‚

é˜¶æ®µä¸€ç»“æœï¼š

```shell
loss: 0.4901, rl: 0.4808, vl: 0.0094: : 10001it [05:10, 11.64it/loss: 0.4901, rl: 0.4808, vl: 0.0094: : 10001it [05:10, 32.18it/s]
wandb:                                                                                
wandb: 
wandb: Run history:
wandb:         codebook_usage_0 â–â–ˆ
wandb:         codebook_usage_1 â–â–
wandb:         codebook_usage_2 â–â–
wandb:           emb_avg_norm_0 â–â–â–„â–„â–…â–‡â–†â–‡â–ˆâ–ˆâ–‡â–ˆâ–ˆâ–ˆâ–‡â–‡â–‡â–ˆâ–ˆâ–‡â–ˆâ–ˆâ–‡â–ˆâ–‡â–ˆâ–ˆâ–ˆâ–ˆâ–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡
wandb:           emb_avg_norm_1 â–â–‚â–…â–…â–†â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‡â–ˆâ–‡â–‡â–‡â–ˆâ–‡â–ˆ
wandb:           emb_avg_norm_2 â–â–ƒâ–„â–†â–†â–†â–‡â–‡â–‡â–‡â–‡â–‡â–ˆâ–‡â–‡â–‡â–‡â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‡â–ˆâ–ˆâ–‡â–‡â–‡â–ˆâ–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡
wandb: eval_reconstruction_loss â–ˆâ–
wandb:          eval_rqvae_loss â–â–ˆ
wandb:          eval_total_loss â–ˆâ–
wandb:            learning_rate â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–
wandb:        max_id_duplicates â–ˆâ–
wandb:             p_unique_ids â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–
wandb:      reconstruction_loss â–ˆâ–†â–…â–„â–„â–ƒâ–‚â–‚â–‚â–ƒâ–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–ƒâ–‚â–‚â–ƒâ–‚â–â–‚â–‚â–â–â–‚â–‚â–‚â–â–‚â–â–â–
wandb:            rqvae_entropy â–ˆâ–
wandb:               rqvae_loss â–â–â–â–â–‚â–ƒâ–„â–…â–…â–†â–‡â–‡â–†â–†â–†â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–ˆâ–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–†â–ˆâ–‡â–‡â–‡â–‡â–‡
wandb:              temperature â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–â–
wandb:               total_loss â–ˆâ–ˆâ–„â–…â–…â–‚â–ƒâ–‚â–‚â–ƒâ–‚â–ƒâ–ƒâ–ƒâ–ƒâ–ƒâ–‚â–‚â–ƒâ–‚â–‚â–â–ƒâ–â–‚â–ƒâ–‚â–ƒâ–‚â–‚â–ƒâ–ƒâ–ƒâ–â–ƒâ–‚â–ƒâ–ƒâ–ƒâ–‚
wandb: 
wandb: Run summary:
wandb:         codebook_usage_0 0.78906
wandb:         codebook_usage_1 0.89844
wandb:         codebook_usage_2 0.59766
wandb:           emb_avg_norm_0 0.06535
wandb:           emb_avg_norm_1 0.03488
wandb:           emb_avg_norm_2 0.02724
wandb: eval_reconstruction_loss 0.48211
wandb:          eval_rqvae_loss 0.00928
wandb:          eval_total_loss 0.49139
wandb:            learning_rate 0.0006
wandb:        max_id_duplicates 0.0005
wandb:             p_unique_ids 1
wandb:      reconstruction_loss 0.47988
wandb:            rqvae_entropy 9.31152
wandb:               rqvae_loss 0.00966
wandb:              temperature 0.2
wandb:               total_loss 0.48953
```

æŒ‡æ ‡ï¼ˆAmazon é˜¶æ®µä¸€ï¼‰ï¼š

- reconstruction_loss è¶Šä½è¶Šå¥½ï¼Œè¡¨ç¤ºç å­—ç»„åˆèƒ½é‡æ„åŸå§‹å‘é‡ã€‚
- rqvae_loss åˆç†çš„é‡çº§å³å¯ï¼Œè¿‡å¤§è¯´æ˜ x ä¸ç å­—è·ç¦»å¤§ï¼›å¯è°ƒ commitment_weight ã€‚
- codebook_usage_* æ¥è¿‘ 1 è¡¨ç¤ºç æœ¬ä½¿ç”¨å‡åŒ€ï¼›è¿‡ä½è¡¨ç¤ºå®¹é‡è¿‡å¤§æˆ–è®­ç»ƒä¸è¶³ã€‚
- rqvae_entropy è¶Šé«˜è¶Šå‡åŒ€ï¼›è¿‡ä½è¡¨ç¤ºè¯­ä¹‰IDé›†ä¸­äºå°‘æ•°ç»„åˆã€‚
- max_id_duplicates è¶Šä½è¶Šå¥½ï¼›è¿‡é«˜è¯´æ˜ä¸åŒç‰©å“æ˜ å°„åˆ°äº†ç›¸åŒè¯­ä¹‰IDã€‚



ç¬¬äºŒé˜¶æ®µä¹Ÿç±»ä¼¼ï¼Œä¸è¿‡æ˜¯é€šè¿‡ç”Ÿæˆå¼çš„ç­–ç•¥ï¼Œæš‚æ—¶å…ˆè·‘é€šä»£ç ï¼Œæœ‰ç‚¹è„‘é›¾çš„æ„Ÿè§‰ï¼Œåé¢åˆ†ææ¢³ç†ç¬¬äºŒé˜¶æ®µ

## æ€è€ƒ

- user/item è¿›è¡Œembeddingåè¿›è¡Œé‡åŒ–ï¼Œæ˜¯åœ¨å¹²ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆè¿™æ ·åšï¼Ÿç›®æ ‡ï¼Ÿ

- å„ä¸ªæ¨¡å—å’Œæ•´ä½“æ¨¡å—çš„è¾“å…¥è¾“å‡ºæ˜¯ä»€ä¹ˆï¼Ÿé•¿å•¥æ ·ï¼Ÿ